<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø®ØªØ¨Ø± Ø§Ù„ÙƒÙØ§Ø¡Ø© - Simulator Micro:bit OS</title>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --panel-bg: #252526;
            --header-bg: #2d2d2d;
            --accent-blue: #007acc;
            --accent-cyan: #4ec9b0;
            --accent-yellow: #dcdcaa;
            --text-gray: #d4d4d4;
            --border-color: #3e3e42;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-gray); 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        header { 
            background: var(--header-bg); 
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border-color);
        }

        .header-right { display: flex; gap: 15px; }
        .header-left { font-family: monospace; font-size: 0.9rem; color: #888; }
        
        .stat-badge { 
            background: #333; 
            border: 1px solid var(--border-color); 
            padding: 5px 15px; 
            border-radius: 4px; 
            font-size: 0.9rem;
        }
        .stat-value { color: #ff6b6b; font-weight: bold; margin-left: 5px; }
        .stat-value.good { color: var(--accent-cyan); }

        .main-title { 
            color: var(--accent-blue); 
            font-size: 1.4rem; 
            margin: 0; 
            font-weight: bold; 
        }

        .layout { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1.2fr; 
            gap: 20px; 
            padding: 20px; 
            height: calc(100vh - 60px); 
            box-sizing: border-box; 
        }

        .panel { 
            background: var(--panel-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            display: flex; 
            flex-direction: column; 
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .panel-header {
            color: var(--accent-yellow);
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        /* Simulator (Left in RTL is logical Right) */
        .simulator-area { align-items: center; justify-content: center; }
        .microbit-case {
            background: #000;
            padding: 30px;
            border-radius: 20px;
            border: 4px solid #333;
            position: relative;
        }
        .running-tag {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--accent-cyan);
            font-weight: bold;
            font-size: 0.8rem;
            display: none;
        }
        .led-grid {
            display: grid;
            grid-template-columns: repeat(5, 45px);
            grid-gap: 10px;
        }
        .led {
            width: 45px;
            height: 45px;
            background: #2a2a2a;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.1s;
        }
        .led.active {
            background: #ff0044;
            box-shadow: 0 0 15px #ff0044;
        }

        .sim-controls {
            margin-top: 25px;
            display: flex;
            gap: 12px;
        }
        .btn-play {
            background: var(--accent-cyan);
            color: #111;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-reset {
            background: #ce9178;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Assets (Center) */
        .input-group {
            display: flex;
            margin-bottom: 20px;
        }
        input[type="text"] {
            background: #3c3c3c;
            border: 1px solid #555;
            color: white;
            padding: 8px;
            border-radius: 0 4px 4px 0;
            flex-grow: 1;
            outline: none;
        }
        .btn-save {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px 0 0 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .assets-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            overflow-y: auto;
        }
        .asset-btn {
            background: transparent;
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            text-align: right;
        }

        /* Code (Right) */
        .code-container { padding: 0; background: #1e1e1e; }
        .code-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #252526;
            border-bottom: 1px solid var(--border-color);
        }
        .filename { font-family: monospace; color: #9cdcfe; font-size: 0.85rem; }
        .btn-copy {
            background: transparent;
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .editor {
            flex-grow: 1;
            font-family: 'Consolas', 'Monaco', monospace;
            padding: 15px;
            direction: ltr;
            text-align: left;
            overflow-y: auto;
            line-height: 1.5;
            font-size: 0.85rem;
            white-space: pre;
        }

        /* Syntax Highlighting */
        .line-num { color: #858585; margin-right: 12px; display: inline-block; width: 25px; text-align: right; user-select: none; }
        .cmd { color: #569cd6; }
        .coords { color: #b5cea8; }
        .func { color: #dcdcaa; }
        .comment { color: #6a9955; }
        .keyword { color: #c586c0; }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-cyan);
            color: #111;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: bold;
            display: none;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

<header>
    <div class="header-right">
        <div class="stat-badge">Ø£Ø³Ø·Ø± Ø§Ù„ÙƒÙˆØ¯: <span id="lineCount" class="stat-value">0</span></div>
        <div class="stat-badge">Ø§Ù„Ø¹Ù†Ø§ØµØ±: <span id="assetCount" class="stat-value good">0</span></div>
    </div>
    <h1 class="main-title">Ù…Ø®ØªØ¨Ø± Ø§Ù„ÙƒÙØ§Ø¡Ø©</h1>
    <div class="header-left">SIMULATOR: Micro:bit OS</div>
</header>

<div class="layout">
    <!-- Simulator Column -->
    <div class="panel simulator-area">
        <div class="panel-header">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆØ¨ÙŠØª</div>
        <div class="microbit-case">
            <div id="runningTag" class="running-tag">â–¶ Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†...</div>
            <div class="led-grid" id="ledGrid"></div>
        </div>
        <div class="sim-controls">
            <button id="playBtn" class="btn-play" onclick="playSequence()">â–¶ ØªØ´ØºÙŠÙ„</button>
            <button class="btn-reset" onclick="clearGrid()">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        </div>
    </div>

    <!-- Assets Column -->
    <div class="panel">
        <div class="panel-header">1. Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± (Ø¯Ø§Ù„Ø©)</div>
        <p style="text-align:center; font-size: 0.8rem; color: #888; margin-top: -5px;">Ø§Ø±Ø³Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø© ÙˆØ§Ø­ÙØ¸ ÙƒØ¯Ø§Ù„Ø©</p>
        <div class="input-group">
            <button class="btn-save" onclick="saveAsset()">Ø­ÙØ¸</button>
            <input type="text" id="assetName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ± (Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)">
        </div>

        <div class="panel-header" style="margin-top: 15px;">2. Ù…Ø®Ø²Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ±</div>
        <div class="assets-grid" id="assetsContainer">
            <button class="asset-btn" onclick="addAssetToCode('creeper')"><span>ğŸ‘¾ ÙƒØ±ÙŠØ¨Ø±</span></button>
            <button class="asset-btn" onclick="addAssetToCode('heart')"><span>â¤ï¸ Ù‚Ù„Ø¨</span></button>
            <button class="asset-btn" onclick="addAssetToCode('smile')"><span>ğŸ˜Š Ø§Ø¨ØªØ³Ø§Ù…Ø©</span></button>
            <button class="asset-btn" onclick="addAssetToCode('arrow_up')"><span>â¬†ï¸ Ø³Ù‡Ù…</span></button>
        </div>
    </div>

    <!-- Code Column -->
    <div class="panel code-container">
        <div class="code-top">
            <span id="fileName" class="filename">main.ts</span>
            <button class="btn-copy" onclick="exportToClipboard()">Ù†Ø³Ø® Ù„Ù€ MakeCode</button>
        </div>
        <div class="editor" id="codeDisplay">
            <span class="comment">// Ø§Ù„Ù„ÙˆØ­Ø© ÙØ§Ø±ØºØ©... Ø§Ø±Ø³Ù… Ø´ÙŠØ¦Ø§Ù‹ ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­ÙØ¸"</span>
        </div>
    </div>
</div>

<div id="toast" class="toast">ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­!</div>

<script>
    const ledGrid = document.getElementById('ledGrid');
    const codeDisplay = document.getElementById('codeDisplay');
    const lineCountDisplay = document.getElementById('lineCount');
    const assetCountDisplay = document.getElementById('assetCount');
    const assetsContainer = document.getElementById('assetsContainer');
    const playBtn = document.getElementById('playBtn');
    const runningTag = document.getElementById('runningTag');
    const toast = document.getElementById('toast');
    const fileName = document.getElementById('fileName');
    
    let leds = [];
    let manualPixels = [];
    let activeAssets = [];
    let isPlaying = false;

    // Initialize Grid
    for (let i = 0; i < 25; i++) {
        const led = document.createElement('div');
        led.className = 'led';
        led.onclick = () => { if(!isPlaying) togglePixel(i); };
        ledGrid.appendChild(led);
        leds.push(led);
    }

    function togglePixel(index) {
        const led = leds[index];
        led.classList.toggle('active');
        
        const x = index % 5;
        const y = Math.floor(index / 5);
        
        if (led.classList.contains('active')) {
            manualPixels.push({x: x, y: y});
        } else {
            manualPixels = manualPixels.filter(p => !(p.x === x && p.y === y));
        }
        updateCodeView();
    }

    function updateCodeView(viewMode = 'main', focusAsset = null) {
        let html = "";
        let lines = 0;
        fileName.innerText = viewMode === 'main' ? 'main.ts' : 'asset_creation.ts';

        if (viewMode === 'asset_definition' && focusAsset) {
            html += `<span class="comment">// ØªØ¹Ø±ÙŠÙ Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯ (Ø¯Ø§Ù„Ø©):</span>\n`;
            lines++;
            html += `<span class="line-num">${lines++}</span><span class="keyword">function</span> <span class="func">${focusAsset.name}</span>() {\n`;
            focusAsset.pattern.forEach(idx => {
                html += `<span class="line-num">${lines++}</span>    <span class="cmd">led.plot</span>(<span class="coords">${idx % 5}, ${Math.floor(idx / 5)}</span>);\n`;
            });
            html += `<span class="line-num">${lines++}</span>}\n\n`;
            html += `<span class="comment">// ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†.</span>\n`;
            html += `<span class="comment">// ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ­Ø© Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯.</span>`;
        } else {
            if (manualPixels.length > 0) {
                html += `<span class="comment">// Ø±Ø³Ù… Ø­Ø± (ØºÙŠØ± ÙƒÙØ¡ - ÙƒÙ„ Ø¨ÙƒØ³Ù„ Ù‡Ùˆ Ø³Ø·Ø±)</span>\n`;
                lines++;
                manualPixels.forEach(p => {
                    html += `<span class="line-num">${lines++}</span><span class="cmd">led.plot</span>(<span class="coords">${p.x}, ${p.y}</span>);\n`;
                });
            }
            if (activeAssets.length > 0) {
                if (manualPixels.length > 0) html += "\n";
                html += `<span class="comment">// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù„ (Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ù†Ø§ØµØ±)</span>\n`;
                lines++;
                activeAssets.forEach(asset => {
                    html += `<span class="line-num">${lines++}</span><span class="func">${asset.name}</span>();\n`;
                    html += `<span class="line-num">${lines++}</span><span class="cmd">basic.pause</span>(<span class="coords">500</span>);\n`;
                    html += `<span class="line-num">${lines++}</span><span class="cmd">basic.clearScreen</span>();\n`;
                });
                
                html += `\n<span class="comment">// ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ø¯ÙˆØ§Ù„ ÙÙŠ Ø£Ø³ÙÙ„ Ø§Ù„ÙƒÙˆØ¯</span>\n`;
                lines++;
                const uniqueAssets = [...new Map(activeAssets.map(item => [item.name, item])).values()];
                uniqueAssets.forEach(asset => {
                    html += `<span class="line-num">${lines++}</span><span class="keyword">function</span> <span class="func">${asset.name}</span>() {\n`;
                    asset.pattern.forEach(idx => {
                        html += `<span class="line-num">${lines++}</span>    <span class="cmd">led.plot</span>(<span class="coords">${idx % 5}, ${Math.floor(idx / 5)}</span>);\n`;
                    });
                    html += `<span class="line-num">${lines++}</span>}\n`;
                });
            }
        }

        codeDisplay.innerHTML = lines === 0 ? `<span class="comment">// Ø§Ù„Ù„ÙˆØ­Ø© ÙØ§Ø±ØºØ©... Ø§Ø±Ø³Ù… Ø´ÙŠØ¦Ø§Ù‹ ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­ÙØ¸"</span>` : html;
        lineCountDisplay.innerText = lines;
        lineCountDisplay.style.color = lines > 30 ? '#ff6b6b' : '#4ec9b0';
    }

    function saveAsset() {
        const nameInput = document.getElementById('assetName');
        const rawName = nameInput.value.trim().replace(/\s+/g, '_') || "my_asset_" + (savedAssetsCount() + 1);
        const name = "draw_" + rawName;

        if (isPlaying) return;
        const currentPattern = [];
        leds.forEach((l, i) => { if (l.classList.contains('active')) currentPattern.push(i); });
        
        if (currentPattern.length === 0) return;

        const assetObj = { name: name, pattern: currentPattern };
        
        const btn = document.createElement('button');
        btn.className = 'asset-btn';
        btn.innerHTML = `<span>ğŸ’ ${rawName}</span>`;
        btn.onclick = () => addAssetToCode(null, assetObj);
        assetsContainer.appendChild(btn);

        manualPixels = []; 
        updateCodeView('asset_definition', assetObj);
        
        leds.forEach(l => l.classList.remove('active'));
        nameInput.value = "";
        showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ØµØ± ÙƒØ¯Ø§Ù„Ø©!");
    }

    function savedAssetsCount() {
        return assetsContainer.querySelectorAll('.asset-btn').length - 4;
    }

    function addAssetToCode(type, customAsset = null) {
        if (isPlaying) return;
        leds.forEach(l => l.classList.remove('active'));
        
        let assetObj = customAsset;
        if (!customAsset) {
            const presets = {
                'creeper': {name:"draw_creeper", pattern:[6, 8, 11, 12, 13, 16, 17, 18, 21, 23]},
                'heart': {name:"draw_heart", pattern:[1, 3, 5, 6, 7, 8, 9, 11, 12, 13, 17]},
                'smile': {name:"draw_smile", pattern:[6, 8, 15, 21, 22, 23, 19]},
                'arrow_up': {name:"draw_arrow_up", pattern:[2, 6, 7, 8, 10, 12, 14, 17, 22]}
            };
            assetObj = presets[type];
        }

        activeAssets.push(assetObj);
        assetCountDisplay.innerText = activeAssets.length;
        
        assetObj.pattern.forEach(i => leds[i].classList.add('active'));
        updateCodeView('main');
    }

    async function playSequence() {
        if (isPlaying || (manualPixels.length === 0 && activeAssets.length === 0)) return;
        
        updateCodeView('main');
        isPlaying = true;
        playBtn.disabled = true;
        runningTag.style.display = "block";
        
        leds.forEach(l => l.classList.remove('active'));

        for (let p of manualPixels) {
            leds[p.y * 5 + p.x].classList.add('active');
            await new Promise(r => setTimeout(r, 100));
        }

        for (let asset of activeAssets) {
            leds.forEach(l => l.classList.remove('active'));
            await new Promise(r => setTimeout(r, 100));
            for (let idx of asset.pattern) {
                leds[idx].classList.add('active');
                await new Promise(r => setTimeout(r, 50));
            }
            await new Promise(r => setTimeout(r, 600));
        }

        leds.forEach(l => l.classList.remove('active'));
        runningTag.style.display = "none";
        playBtn.disabled = false;
        isPlaying = false;
    }

    function clearGrid() {
        leds.forEach(l => l.classList.remove('active'));
        manualPixels = [];
        activeAssets = [];
        assetCountDisplay.innerText = "0";
        updateCodeView('main');
    }

    function exportToClipboard() {
        let code = "// Export to MakeCode\n";
        activeAssets.forEach(a => {
            code += `${a.name}()\nbasic.pause(500)\nbasic.clearScreen()\n`;
        });
        
        const uniqueAssets = [...new Map(activeAssets.map(item => [item.name, item])).values()];
        uniqueAssets.forEach(a => {
            code += `\nfunction ${a.name}() {\n`;
            a.pattern.forEach(i => {
                code += `    led.plot(${i % 5}, ${Math.floor(i / 5)})\n`;
            });
            code += "}\n";
        });

        const textarea = document.createElement("textarea");
        textarea.value = code;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯!");
    }

    function showToast(msg) {
        toast.innerText = msg;
        toast.style.display = "block";
        setTimeout(() => { toast.style.display = "none"; }, 3000);
    }
</script>

</body>
</html>
